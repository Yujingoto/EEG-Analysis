<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ page.title }} | {{ site.title }}</title>
  <link rel="stylesheet" href="{{ "/assets/css/custom.css" | relative_url }}">
  {% seo %}

  <!-- MathJax -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        displayMath: [['$$','$$'], ['\\[','\\]']],
        processEscapes: true,
        packages: { '[+]': ['ams'] },
        macros: {
          bm: ['\\boldsymbol{#1}', 1],
          argmax: '\\operatorname*{arg\\,max}',
          argmin: '\\operatorname*{arg\\,min}'
        }
      },
      chtml: { linebreaks: { automatic: false } },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>

<body>
  {% include header.html %}

  <div id="layout">
    <div class="page-wrap">
      <main class="content">
        <!-- üîç „Çµ„Ç§„ÉàÂÜÖÊ§úÁ¥¢„Éú„ÉÉ„ÇØ„ÇπÔºàË®ò‰∫ã„ÅÆ‰∏äÈÉ®Âè≥ÂØÑ„ÅõÔºâ -->
        <div id="search-box" style="text-align:right; margin-top: 0.5em; margin-bottom: 1em;">
          <input type="text" id="search-input" placeholder="„Çµ„Ç§„ÉàÂÜÖÊ§úÁ¥¢..." 
                style="width: 220px; padding: 4px; font-size: 0.9em;">
          <div id="search-results" 
              style="margin-top: 0.5em; font-size: 0.9em; text-align:left;"></div>
        </div>
        <!-- Ë®ò‰∫ãÂè≥‰∏ä„ÅÆÊúÄÁµÇÊõ¥Êñ∞ÔºàGitHub API„ÅßÂèñÂæóÔºâ -->
        <div class="last-updated" data-path="{{ page.path | escape }}"></div>

        {{ content }}
      </main>

      <aside id="toc-side" class="toc-side" aria-label="„Éö„Éº„Ç∏ÂÜÖ„É™„É≥„ÇØ"></aside>
    </div>
  </div>

  <!-- ÊúÄÁµÇÊõ¥Êñ∞Êó•ÊôÇ„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫ -->
  <script>
    (function () {
      const el = document.querySelector('.last-updated');
      if (!el) return;
      const owner = 'Yujingoto';            // ‚Üê „É™„Éù„Ç∏„Éà„É™ÊâÄÊúâËÄÖ
      const repo  = 'EEG-Analysis';         // ‚Üê „É™„Éù„Ç∏„Éà„É™Âêç
      const path  = el.dataset.path || '';
      if (!path) return;

      const url = `https://api.github.com/repos/${owner}/${repo}/commits?path=${encodeURIComponent(path)}&per_page=1`;
      fetch(url, { headers: { 'Accept': 'application/vnd.github+json' } })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(data => {
          if (!data || !data[0]) return;
          const d = new Date(data[0].commit.committer.date);
          const txt = d.toLocaleDateString('ja-JP', { year:'numeric', month:'2-digit', day:'2-digit' });
          el.textContent = `ÊúÄÁµÇÊõ¥Êñ∞Ôºö${txt}`;
          el.style.display = 'inline';
        })
        .catch(() => { el.style.display = 'none'; });
    })();
  </script>
  <!-- Êú´Â∞æ„ÅÆ„Çπ„ÇØ„É™„Éó„ÉàÁõ¥Ââç„Å´ËøΩÂä†Ôºàlunr„Å®Ê§úÁ¥¢JSÔºâ -->
  <script src="https://cdn.jsdelivr.net/npm/lunr/lunr.min.js"></script>
  <script>
  (function () {
    // Êó•‰ªò
    const el = document.querySelector('.last-updated');
    if (el) {
      const owner='Yujingoto', repo='EEG-Analysis', path=el.dataset.path||'';
      if (path) {
        fetch(`https://api.github.com/repos/${owner}/${repo}/commits?path=${encodeURIComponent(path)}&per_page=1`,
          {headers:{'Accept':'application/vnd.github+json'}})
          .then(r=>r.ok?r.json():Promise.reject()).then(d=>{
            if (!d||!d[0]) return;
            const dt=new Date(d[0].commit.committer.date);
            el.textContent=`ÊúÄÁµÇÊõ¥Êñ∞Ôºö${dt.toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit'})}`;
          }).catch(()=>{ el.style.display='none'; });
      }
    }

    // Ê§úÁ¥¢
    const input = document.getElementById('search-input');
    const out   = document.getElementById('search-results');
    if (!input || !out) return;

    let DB=[], idx=null;
    const build = (docs)=>{
      idx = lunr(function(){
        this.ref('url'); this.field('title'); this.field('content');
        docs.forEach(d=>this.add(d));
      });
    };

    fetch('{{ "/search.json" | relative_url }}').then(r=>r.json()).then(d=>{ DB=d; build(DB); }).catch(()=>{});

    const snippet=(text,q)=>{
      const t=text||"", k=q.toLowerCase(), i=t.toLowerCase().indexOf(k);
      if (i<0) return t.slice(0,120)+'‚Ä¶';
      const s=Math.max(0,i-40), e=Math.min(t.length,i+k.length+40);
      return (s?'‚Ä¶':'')+t.slice(s,e)+(e<t.length?'‚Ä¶':'');
    };

    const run=(q)=>{
      if (!idx || !q.trim()){ out.hidden=true; out.innerHTML=''; return; }
      const hits = idx.search(q).slice(0,10);
      out.innerHTML = hits.length
        ? '<ul class="hits">'+hits.map(h=>{
            const d=DB.find(x=>x.url===h.ref); if(!d) return '';
            return `<li><a href="${d.url}">${d.title}</a><div class="s">${snippet(d.content,q)}</div></li>`;
          }).join('')+'</ul>'
        : '<div class="nohit">Ë©≤ÂΩì„Å™„Åó</div>';
      out.hidden=false;
    };

    let tid=null;
    input.addEventListener('input', ()=>{ clearTimeout(tid); tid=setTimeout(()=>run(input.value),120); });
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); run(input.value); } });
  })();
  </script>

  <script src="{{ "/assets/js/toc.js" | relative_url }}" defer></script>
  <script src="{{ "/assets/js/mathwrap.js" | relative_url }}" defer></script>
  <script src="{{ "/assets/js/search.js" | relative_url }}" defer></script>
</body>
</html>
