{%- comment -%}
  自動サイトマップ（Liquid 3 互換・安全版）
  前提:
    - 各ページの front matter に categories: [Top, Sub]
    - nav_order で並び順（未指定は末尾）
    - hide_in_nav: true で非表示
{%- endcomment -%}

<div class="header">
  <table class="fixed-table">
    <thead>
      <tr>
        <th class="mokuji">目次</th>

        {%- comment -%} 対象ページを絞る {%- endcomment -%}
        {%- assign pages_all = site.pages
          | where_exp:"p","p.title"
          | where_exp:"p","p.url"
          | where_exp:"p","p.hide_in_nav != true"
        -%}

        {%- comment -%} Topカテゴリ一覧を収集 → uniq → sort {%- endcomment -%}
        {%- assign topcats_raw = "" -%}
        {%- for p in pages_all -%}
          {%- if p.categories and p.categories.size > 0 -%}
            {%- assign top = p.categories[0] -%}
            {%- if top -%}
              {%- capture topcats_raw -%}{{ topcats_raw }}|||{{ top }}{%- endcapture -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        {%- assign topcats = topcats_raw | split:"|||" | uniq | sort -%}

        {%- for topcat in topcats -%}
          {%- if topcat != "" -%}
          <th>
            <details>
              <summary>{{ topcat }}</summary>

              {%- comment -%} この Top の配下ページ {%- endcomment -%}
              {%- assign top_items = pages_all | where_exp:"p","p.categories and p.categories[0] == topcat" -%}

              {%- comment -%} Subカテゴリ一覧を収集 → uniq → sort {%- endcomment -%}
              {%- assign subcats_raw = "" -%}
              {%- for p in top_items -%}
                {%- assign sub = "" -%}
                {%- if p.categories and p.categories.size > 1 -%}
                  {%- assign sub = p.categories[1] -%}
                {%- else -%}
                  {%- assign sub = "ホーム" -%}
                {%- endif -%}
                {%- capture subcats_raw -%}{{ subcats_raw }}|||{{ sub }}{%- endcapture -%}
              {%- endfor -%}
              {%- assign subcats = subcats_raw | split:"|||" | uniq | sort -%}

              {%- for subcat in subcats -%}
                {%- if subcat != "" -%}
                <ul class="gnav">
                  <details>
                    <summary>{{ subcat }}</summary>
                    <ul class="index">
                      {%- assign sub_items = top_items | where_exp:"p","p.categories and p.categories.size > 1 and p.categories[1] == subcat" -%}
                      {%- if sub_items == empty -%}
                        {%- assign sub_items = top_items | where_exp:"p","!(p.categories and p.categories.size > 1)" -%}
                      {%- endif -%}

                      {%- assign sorted = sub_items | sort:"nav_order" -%}
                      {%- for page in sorted -%}
                        {%- assign title = page.nav_title | default: page.title -%}
                        {%- if title -%}
                          <li><a href="{{ page.url | relative_url }}">{{ title }}</a></li>
                        {%- endif -%}
                      {%- endfor -%}
                    </ul>
                  </details>
                </ul>
                {%- endif -%}
              {%- endfor -%}

            </details>
          </th>
          {%- endif -%}
        {%- endfor -%}

      </tr>
    </thead>
  </table>
</div>

<style>
.fixed-table{width:100%;table-layout:fixed;border-collapse:collapse}
.fixed-table th{vertical-align:top;text-align:left;padding:.25rem .5rem}
.gnav,.index{list-style:none;margin:0;padding-left:.75rem}
.header details summary{cursor:pointer}
</style>
