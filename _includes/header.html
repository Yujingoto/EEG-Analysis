{%- comment -%}
  自動サイトマップ（Liquid 3 互換）
  前提:
    - 各ページの front matter に categories: [Top, Sub]（Sub なければ省略可）
    - nav_order で並び替え（未指定は事実上末尾寄り）
    - hide_in_nav: true で非表示
{%- endcomment -%}

<div class="header">
  <div class="header-search-fixed">
    <a href="{{ '/Home/index.html' | relative_url }}" class="site-title">脳波解析をがんばる</a>
    <input id="search-input" type="search" placeholder="サイト内検索">
    <div id="search-results" hidden>
      <ul class="hits"></ul>
    </div>
  </div>

  <table class="fixed-table">
    <thead>
      <tr>
        <th class="mokuji">記事一覧</th>

        {%- assign pages_sorted = site.pages | sort:"nav_order" -%}

        {%- comment -%} Topカテゴリを収集 {%- endcomment -%}
        {%- assign topcats_raw = "" -%}
        {%- for p in pages_sorted -%}
          {%- if p.title and p.url and p.hide_in_nav != true and p.name != "404.html" -%}
            {%- if p.categories and p.categories.size > 0 -%}
              {%- assign top = p.categories[0] -%}
              {%- if top -%}{%- capture topcats_raw -%}{{ topcats_raw }}|||{{ top }}{%- endcapture -%}{%- endif -%}
            {%- endif -%}
          {%- endif -%}
        {%- endfor -%}
        {%- assign topcats = topcats_raw | split:"|||" | uniq | sort -%}

        {%- for topcat in topcats -%}
          {%- if topcat != "" -%}
          <th>
            <details>
              <summary>{{ topcat }}</summary>

              {%- comment -%} Subカテゴリを収集（無いページは「ホーム」扱い） {%- endcomment -%}
              {%- assign subcats_raw = "" -%}
              {%- for p in pages_sorted -%}
                {%- if p.title and p.url and p.hide_in_nav != true and p.categories and p.categories.size > 0 and p.categories[0] == topcat -%}
                  {%- if p.categories.size > 1 -%}
                    {%- assign sub = p.categories[1] -%}
                  {%- else -%}
                    {%- assign sub = "ホーム" -%}
                  {%- endif -%}
                  {%- capture subcats_raw -%}{{ subcats_raw }}|||{{ sub }}{%- endcapture -%}
                {%- endif -%}
              {%- endfor -%}
              {%- assign subcats = subcats_raw | split:"|||" | uniq | sort -%}

              {%- for subcat in subcats -%}
                {%- if subcat != "" -%}
                <ul class="gnav">
                  <details>
                    <summary>{{ subcat }}</summary>
                    <ul class="index">
                      {%- for page in pages_sorted -%}
                        {%- if page.title and page.url and page.hide_in_nav != true and page.categories and page.categories.size > 0 and page.categories[0] == topcat -%}
                          {%- if page.categories.size > 1 -%}
                            {%- if page.categories[1] == subcat -%}
                              <li><a href="{{ page.url | relative_url }}">{{ page.nav_title | default: page.title }}</a></li>
                            {%- endif -%}
                          {%- else -%}
                            {%- if subcat == "ホーム" -%}
                              <li><a href="{{ page.url | relative_url }}">{{ page.nav_title | default: page.title }}</a></li>
                            {%- endif -%}
                          {%- endif -%}
                        {%- endif -%}
                      {%- endfor -%}
                    </ul>
                  </details>
                </ul>
                {%- endif -%}
              {%- endfor -%}

            </details>
          </th>
          {%- endif -%}
        {%- endfor -%}
      </tr>
    </thead>
  </table>
</div>

<style>
.fixed-table{width:100%;table-layout:fixed;border-collapse:collapse}
.fixed-table th{vertical-align:top;text-align:left;padding:.25rem .5rem}
.gnav,.index{list-style:none;margin:0;padding-left:.75rem}
.header details summary{cursor:pointer}
</style>
